{% extends "bootstrap/base.html" %}
{% block title %}喂奶记录{% endblock %}

{% block content %}
<div class="container">
    <h2>喂奶计时器</h2>
    
    <div class="row mt-4">
        <!-- 左侧计时器 -->
        <div class="col-6">
            <div class="card">
                <div class="card-body text-center">
                    <h3>左侧</h3>
                    <div class="display-4" id="leftTimer">00:00</div>
                    <div class="btn-group mt-3">
                        <button class="btn btn-lg btn-primary" id="leftBtn" onclick="toggleTimer('left')">
                            开始
                        </button>
                        <button class="btn btn-lg btn-outline-secondary" onclick="resetSideTimer('left')">
                            清零
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 右侧计时器 -->
        <div class="col-6">
            <div class="card">
                <div class="card-body text-center">
                    <h3>右侧</h3>
                    <div class="display-4" id="rightTimer">00:00</div>
                    <div class="btn-group mt-3">
                        <button class="btn btn-lg btn-primary" id="rightBtn" onclick="toggleTimer('right')">
                            开始
                        </button>
                        <button class="btn btn-lg btn-outline-secondary" onclick="resetSideTimer('right')">
                            清零
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 总结卡片 -->
    <div class="card mt-4">
        <div class="card-body">
            <h4>本次喂奶总结</h4>
            <p>总时长: <span id="totalTime">0</span> 分钟</p>
            <p>左侧: <span id="leftTotal">0</span> 分钟</p>
            <p>右侧: <span id="rightTotal">0</span> 分钟</p>
            <p>最后喂养: <span id="lastSide">-</span></p>
            {% if timer_state and timer_state.last_side %}
            <div class="text-muted mb-3">
                最后喂养: {{ timer_state.last_side|side_to_cn }}侧
            </div>
            {% endif %}
            <button class="btn btn-success" onclick="saveFeeding()">保存记录</button>
            <a href="/" class="btn btn-outline-secondary">返回主页</a>
        </div>
    </div>
</div>

<script>
let timers = {
    left: { running: false, time: 0, lastSync: 0 },
    right: { running: false, time: 0, lastSync: 0 }
};

let localTimer;

function startLocalTimer() {
    if (localTimer) return;
    
    localTimer = setInterval(() => {
        ['left', 'right'].forEach(side => {
            if (timers[side].running) {
                timers[side].time++;
                updateDisplay(side);
                updateSummary();
            }
        });
    }, 1000);
}

function stopLocalTimer() {
    if (localTimer) {
        clearInterval(localTimer);
        localTimer = null;
    }
}

function syncWithServer() {
    fetch('/timer/state')
        .then(response => response.json())
        .then(state => {
            // 更新计时器状态
            for (const [side, data] of Object.entries(state)) {
                if (side !== 'last_side') {
                    const localTime = timers[side].running ? 
                        (timers[side].time + Math.floor((Date.now() - timers[side].lastSync) / 1000)) : 
                        timers[side].time;
                    
                    // 如果时间差异超过2秒，使用服务器时间
                    if (Math.abs(localTime - data.time) > 2) {
                        timers[side].time = data.time;
                    }
                    
                    timers[side].running = data.running;
                    timers[side].lastSync = Date.now();
                    
                    updateButtonState(side);
                    updateDisplay(side);
                }
            }
            updateLastSide(state.last_side);
            updateSummary();
            
            // 根据运行状态管理本地计时器
            if (timers.left.running || timers.right.running) {
                startLocalTimer();
            } else {
                stopLocalTimer();
            }
        });
}

function toggleTimer(side) {
    fetch(`/timer/toggle/${side}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            syncWithServer();
        }
    });
}

function updateButtonState(side) {
    const btn = document.getElementById(`${side}Btn`);
    if (timers[side].running) {
        btn.textContent = '停止';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-danger');
    } else {
        btn.textContent = '开始';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-primary');
    }
}

function updateDisplay(side) {
    const minutes = Math.floor(timers[side].time / 60);
    const seconds = timers[side].time % 60;
    document.getElementById(`${side}Timer`).textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function updateLastSide(lastSide) {
    let sideText = '-';
    if (lastSide) {
        // 将 left/right 转换为中文
        const sideMap = {
            'left': '左',
            'right': '右'
        };
        sideText = `${sideMap[lastSide]}侧`;
    }
    document.getElementById('lastSide').textContent = sideText;
}

function updateSummary() {
    const leftMinutes = Math.floor(timers.left.time / 60);
    const rightMinutes = Math.floor(timers.right.time / 60);
    document.getElementById('totalTime').textContent = leftMinutes + rightMinutes;
    document.getElementById('leftTotal').textContent = leftMinutes;
    document.getElementById('rightTotal').textContent = rightMinutes;
}

// 修改重置函数
function resetSideTimer(side) {
    fetch(`/timer/reset/${side}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            syncWithServer();
        }
    });
}

function saveFeeding() {
    // 检查是否有正在运行的计时器，并将其作为最后喂养侧
    let lastSide = document.getElementById('lastSide').textContent;
    if (timers.left.running) {
        lastSide = '左侧';
    } else if (timers.right.running) {
        lastSide = '右侧';
    }
    
    const totalMinutes = Math.floor((timers.left.time + timers.right.time) / 60);
    const notes = `左侧: ${Math.floor(timers.left.time/60)}分钟, ` +
                 `右侧: ${Math.floor(timers.right.time/60)}分钟, ` +
                 `最后喂养: ${lastSide}`;
    
    // 如果有计时器在运行，先停止计时
    const stopTimerPromises = [];
    if (timers.left.running) {
        stopTimerPromises.push(fetch('/timer/toggle/left', { method: 'POST' }));
    }
    if (timers.right.running) {
        stopTimerPromises.push(fetch('/timer/toggle/right', { method: 'POST' }));
    }

    // 等待所有计时器停止后再保存
    Promise.all(stopTimerPromises)
        .then(() => {
            const formData = new FormData();
            formData.append('type', '吃奶');
            formData.append('duration', totalMinutes);
            formData.append('notes', notes);
            
            return fetch('/add_event', {
                method: 'POST',
                body: formData
            });
        })
        .then(response => response.json())
        .then(() => fetch('/timer/reset', { method: 'POST' }))
        .then(() => window.location.href = '/')
        .catch(error => console.error('Error:', error));
}

// 修改页面加载时的初始化
document.addEventListener('DOMContentLoaded', function() {
    syncWithServer();
    
    // 每30秒同步一次
    setInterval(syncWithServer, 30000);
    
    // 页面可见性变化时同步
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            syncWithServer();
        }
    });
});
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setLastVisitedPage('/feeding');
});
</script>
{% endblock %}