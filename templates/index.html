{% extends "bootstrap/base.html" %}
{% from 'bootstrap5/utils.html' import render_icon %}

{% block title %}BabyCare æ—¶é—´è½´{% endblock %}

{% block content %}
<div class="container">
    <h2>å®å®ä½œæ¯è®°å½•</h2>
    
    <!-- äº‹ä»¶è®°å½•è¡¨å• -->
    <form class="mb-4" onsubmit="return submitEvent()">
        <select class="form-select mb-2" id="type">
            <option value="äº‹ä»¶">äº‹ä»¶</option>

            <!-- åŸºç¡€ç”Ÿç†éœ€æ±‚ -->
            <option value="åƒå¥¶">åƒå¥¶</option>
            <option value="ç¡çœ ">ç¡çœ </option>
            <option value="æ¢å°¿å¸ƒ">æ¢å°¿å¸ƒ</option>
            
            <!-- å«ç”ŸæŠ¤ç† -->
            <option value="æ´—æ¾¡">æ´—æ¾¡</option>
            <option value="å‰ªæŒ‡ç”²">å‰ªæŒ‡ç”²</option>
            
            <!-- å¥åº·ç›¸å…³ -->
            <option value="åƒè¯">åƒè¯</option>
            <option value="ä½“æ¸©æµ‹é‡">ä½“æ¸©æµ‹é‡</option>
            <option value="æ‰“ç–«è‹—">æ‰“ç–«è‹—</option>
            
            <!-- æˆé•¿è®°å½• -->
            <option value="ä½“é‡æµ‹é‡">ä½“é‡æµ‹é‡</option>
            <option value="èº«é«˜æµ‹é‡">èº«é«˜æµ‹é‡</option>
            
            <!-- äº’åŠ¨æ´»åŠ¨ -->
            <option value="æˆ·å¤–æ´»åŠ¨">æˆ·å¤–æ´»åŠ¨</option>
            <option value="äº²å­æ¸¸æˆ">äº²å­æ¸¸æˆ</option>
            
        </select>
        
        <!-- æ·»åŠ æ—¶é—´é€‰æ‹©å™¨ -->
        <input type="datetime-local" class="form-control mb-2" 
               id="eventTime" 
               max="{{ datetime.now().strftime('%Y-%m-%dT%H:%M') }}">
        
        <div id="durationGroup">
            <input type="number" class="form-control mb-2" 
                   id="duration" placeholder="æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰">
        </div>
        
        <textarea class="form-control mb-2" 
                  id="notes" placeholder="å¤‡æ³¨"></textarea>
        
        <!-- åœ¨è¡¨å•æäº¤æŒ‰é’®æ—æ·»åŠ  -->
        <div class="btn-group">
            <button type="submit" class="btn btn-primary">è®°å½•äº‹ä»¶</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">å–æ¶ˆ</button>
        </div>
    </form>

    <!-- åœ¨è¡¨å•ä¸­æ·»åŠ è·³è½¬æŒ‰é’® -->
    <div class="mb-3">
        <a href="/feeding" class="btn btn-info">
            ä½¿ç”¨å–‚å¥¶è®¡æ—¶å™¨ ğŸ¼
        </a>
    </div>

    <!-- åœ¨è®°å½•äº‹ä»¶è¡¨å•ä¸‹æ–¹æ·»åŠ æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>æ—¶é—´èŒƒå›´</h5>
        <select class="form-select w-auto" id="timeRange" onchange="updateTimeRange()">
            <option value="24">æœ€è¿‘24å°æ—¶</option>
            <option value="48">æœ€è¿‘48å°æ—¶</option>
            <option value="72">æœ€è¿‘3å¤©</option>
            <option value="168">æœ€è¿‘7å¤©</option>
        </select>
    </div>

    <!-- äº‹ä»¶æ—¶é—´è½´ -->
    <div class="list-group">
        {% for event in events %}
        <div class="list-group-item d-flex justify-content-between align-items-start">
            <div>
                <h5>{{ event.event_type }}</h5>
                <small>{{ event.start_time|strftime('%Y-%m-%d %H:%M') }}</small>
                {% if event.duration|convert_int > 0 %}
                    <small class="ms-2">
                        <i class="bi bi-clock"></i> {{ event.duration }}åˆ†é’Ÿ
                    </small>
                {% endif %}
                <p class="mb-0">{{ event.notes }}</p>
            </div>
            <div>
                <button class="btn btn-primary btn-sm me-2" 
                        onclick="editEvent({{ event.id }}, '{{ event.event_type }}', '{{ event.start_time|strftime('%Y-%m-%dT%H:%M') }}', '{{ event.duration }}', '{{ event.notes|escape }}')"
                        style="height: fit-content;">
                    {{ render_icon('pencil') }}
                </button>
                <button class="btn btn-danger btn-sm" 
                        onclick="deleteEvent({{ event.id }})"
                        style="height: fit-content;">
                    {{ render_icon('trash') }}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- å°†åŸæœ‰çš„é“¾æ¥æ”¹ä¸ºæŒ‰é’® -->
    <button onclick="goToAnalysis()" class="btn btn-info mt-3">ç”ŸæˆAIå»ºè®®</button>
</div>

<!-- ä¿®æ”¹AIåˆ†ææŒ‰é’®ï¼Œæ·»åŠ hourså‚æ•° -->
<script>
function goToAnalysis() {
    const hours = document.getElementById('timeRange').value;
    window.location.href = `/analyze?hours=${hours}&new=true`;
}
</script>

<script>
function submitEvent() {
    const submitBtn = document.querySelector('button[type="submit"]');
    const editId = submitBtn.getAttribute('data-edit-id');
    const formData = new FormData();
    
    formData.append('type', document.getElementById('type').value);
    formData.append('time', document.getElementById('eventTime').value);
    formData.append('duration', document.getElementById('duration').value);
    formData.append('notes', document.getElementById('notes').value);
    
    const url = editId ? `/edit_event/${editId}` : '/add_event';
    const method = editId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Error:', error));
    
    return false;
}

function deleteEvent(eventId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        fetch(`/delete_event/${eventId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => console.error('Error:', error));
    }
}

function updateTimeRange() {
    const hours = document.getElementById('timeRange').value;
    // å­˜å‚¨é€‰æ‹©çš„æ—¶é—´èŒƒå›´åˆ° localStorage
    localStorage.setItem('selectedHours', hours);
    // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°æ—¶é—´è½´
    window.location.href = `/?hours=${hours}`;
}

function updateFormByType() {
    const type = document.getElementById('type').value;
    const durationInput = document.getElementById('duration');
    const durationGroup = document.getElementById('durationGroup');
    const notesInput = document.getElementById('notes');
    
    // å®šä¹‰ä¸éœ€è¦æŒç»­æ—¶é—´çš„äº‹ä»¶ç±»å‹
    const noDurationEvents = ['æ¢å°¿å¸ƒ', 'å‰ªæŒ‡ç”²', 'ä½“æ¸©æµ‹é‡', 'ä½“é‡æµ‹é‡', 'èº«é«˜æµ‹é‡', 'æ‰“ç–«è‹—'];
    
    // æ§åˆ¶æŒç»­æ—¶é—´è¾“å…¥æ¡†çš„æ˜¾ç¤º/éšè—
    if (noDurationEvents.includes(type)) {
        durationGroup.style.display = 'none';
        durationInput.value = '0'; // è®¾ç½®é»˜è®¤å€¼
    } else {
        durationGroup.style.display = 'block';
        durationInput.value = '';
    }
    
    // æ ¹æ®äº‹ä»¶ç±»å‹è®¾ç½®æç¤º
    switch(type) {
        case 'åƒå¥¶':
            durationInput.placeholder = "æŒç»­æ—¶é—´ï¼ˆä¸€èˆ¬15-30åˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆå¦‚ï¼šå–äº†å¤šå°‘mlã€æ˜¯å¦åå¥¶ç­‰ï¼‰";
            break;
        case 'ç¡çœ ':
            durationInput.placeholder = "æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆå¦‚ï¼šå“­é—¹æƒ…å†µã€å…¥ç¡è´¨é‡ç­‰ï¼‰";
            break;
        case 'æ¢å°¿å¸ƒ':
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆå¦‚ï¼šå¤§å°ä¾¿æƒ…å†µã€çº¢ç–¹ç­‰ï¼‰";
            break;
        case 'æ´—æ¾¡':
            durationInput.placeholder = "æŒç»­æ—¶é—´ï¼ˆä¸€èˆ¬10-15åˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆå¦‚ï¼šæ°´æ¸©ã€çš®è‚¤çŠ¶å†µç­‰ï¼‰";
            break;
        case 'å‰ªæŒ‡ç”²':
            durationInput.placeholder = "æŒç»­æ—¶é—´ï¼ˆä¸€èˆ¬5-10åˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆå¦‚ï¼šæ‰‹æŒ‡/è„šè¶¾ã€æ˜¯å¦å®Œæˆç­‰ï¼‰";
            break;
            
        // å¥åº·ç›¸å…³
        case 'åƒè¯':
            durationInput.placeholder = "ç”¨è¯é—´éš”ï¼ˆå°æ—¶ï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆè¯åã€å‰‚é‡ã€æ³¨æ„äº‹é¡¹ç­‰ï¼‰";
            break;
        case 'ä½“æ¸©æµ‹é‡':
            durationInput.placeholder = "æµ‹é‡ç”¨æ—¶ï¼ˆä¸€èˆ¬1-2åˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆä½“æ¸©æ•°å€¼ã€ç²¾ç¥çŠ¶æ€ç­‰ï¼‰";
            break;
        case 'æ‰“ç–«è‹—':
            durationInput.placeholder = "è§‚å¯Ÿæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆç–«è‹—åç§°ã€æ¥ç§éƒ¨ä½ã€ååº”ç­‰ï¼‰";
            break;
            
        // æˆé•¿è®°å½•
        case 'ä½“é‡æµ‹é‡':
            durationInput.placeholder = "æµ‹é‡ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆä½“é‡æ•°å€¼ã€ç”Ÿé•¿æ›²çº¿ç­‰ï¼‰";
            break;
        case 'èº«é«˜æµ‹é‡':
            durationInput.placeholder = "æµ‹é‡ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆèº«é«˜æ•°å€¼ã€ç”Ÿé•¿æ›²çº¿ç­‰ï¼‰";
            break;
            
        // äº’åŠ¨æ´»åŠ¨
        case 'æˆ·å¤–æ´»åŠ¨':
            durationInput.placeholder = "æ´»åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆæ´»åŠ¨åœ°ç‚¹ã€å¤©æ°”æƒ…å†µç­‰ï¼‰";
            break;
        case 'äº²å­æ¸¸æˆ':
            durationInput.placeholder = "æ´»åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆæ¸¸æˆå†…å®¹ã€å®å®ååº”ç­‰ï¼‰";
            break;
            
        // å…¶ä»–
        default:
            durationInput.placeholder = "æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰";
            notesInput.placeholder = "å¤‡æ³¨ï¼ˆè¯·è¯¦ç»†æè¿°äº‹ä»¶ï¼‰";
    }
}

// åœ¨type selectçš„onchangeäº‹ä»¶ä¸­è°ƒç”¨
document.getElementById('type').onchange = updateFormByType;

// é¡µé¢åŠ è½½æ—¶è®¾ç½®é€‰ä¸­çš„æ—¶é—´èŒƒå›´
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || localStorage.getItem('selectedHours') || '24';
    document.getElementById('timeRange').value = hours;
});

function editEvent(id, type, time, duration, notes) {
    // å¡«å……è¡¨å•
    document.getElementById('type').value = type;
    document.getElementById('eventTime').value = time;
    document.getElementById('duration').value = duration;
    document.getElementById('notes').value = notes;
    
    // æ›´æ–°è¡¨å•å ä½ç¬¦
    updateFormByType();
    
    // ä¿®æ”¹æäº¤æŒ‰é’®
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.textContent = 'æ›´æ–°è®°å½•';
    submitBtn.setAttribute('data-edit-id', id);
    
    // æ»šåŠ¨åˆ°è¡¨å•
    document.querySelector('form').scrollIntoView({ behavior: 'smooth' });
}

// æ·»åŠ é‡ç½®è¡¨å•å‡½æ•°
function resetForm() {
    document.querySelector('form').reset();
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.textContent = 'è®°å½•äº‹ä»¶';
    submitBtn.removeAttribute('data-edit-id');
    updateFormByType();
}
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setLastVisitedPage('/');
});
</script>
{% endblock %}
